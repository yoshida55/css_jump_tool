# ChromaDB 類似度閾値が低すぎて無関係なデータが表示される

**日付**: 2025-12-29
**Keywords**: ChromaDB, 類似度, 閾値, threshold, min_score, 検索精度, 無関係, embedding, ベクトル検索
**Error**: なし（機能的には動作するが、関係ないデータが表示される）
**影響範囲**: 図解・画像の自動表示機能
**重要度**: 🟡 Important

---

## 症状

「JavaScript」で検索しても、Flexboxに関する図解や画像が表示される。

**期待動作**: 関連するデータのみ表示
**実際の動作**: 類似度40%程度の無関係なデータも表示される

---

## 原因

類似度の閾値（min_score）が40%と低すぎた。

```python
# 問題のコード
visual_results = chroma_manager.search_visuals(
    query=query,
    min_score=0.4,  # 40%は低すぎる
    top_k=3
)
```

**根本原因**:
- embedding の類似度40%は、意味的に関連性が低い
- 異なるトピック間でも40%程度の類似度になることがある
- 例: 「JavaScript」と「Flexbox」の類似度 ≒ 50-60%

---

## 対処

閾値を65%に引き上げ。

```python
# 修正後のコード
visual_results = chroma_manager.search_visuals(
    query=query,
    min_score=0.65,  # 65%以上で表示
    top_k=3
)

image_results = chroma_manager.search_images(
    query=query,
    min_score=0.65,  # 65%以上で表示
    top_k=3
)
```

**ポイント**:
- 65%は「ある程度関連がある」レベル
- 85%以上は「ほぼ同じ意図」レベル
- 用途に応じて閾値を調整

---

## 類似度の目安

| 類似度 | 意味 | 用途例 |
|--------|------|--------|
| 90%+ | ほぼ同一 | キャッシュ完全一致 |
| 85%+ | 同じ意図 | AI回答キャッシュ |
| 65%+ | 関連あり | 図解・画像表示 |
| 50%+ | やや関連 | 参考程度 |
| 40%以下 | 無関係 | 表示不要 |

---

## 修正ファイル

- `pages/1_🔍_検索.py` (行178, 253)

---

## 予防策

1. 類似度閾値は実際のデータで検証してから決める
2. 閾値を設定ファイルで管理し、調整可能にする
3. ログに類似度スコアを出力して確認

---

## 学んだこと

- embedding の類似度は直感と異なることがある
- 閾値は高めから始めて、必要に応じて下げる方が安全
- 用途によって適切な閾値は異なる
