# セクション分割が機能しない問題

**日付**: 2025-12-29
**Keywords**: セクション分割, ##見出し, split_answer_into_sections, AI回答, 構造化
**Error**: セクション分割結果が1セクションのみになる
**影響範囲**: 検索ページのセクション別図解生成機能
**重要度**: 🟡 Important

---

## 症状

セクション別図解生成機能が動作しない。

**期待動作**: AI回答が複数セクションに分割され、各セクションに図解ボタンが表示される
**実際の動作**: セクション分割結果が1セクションのみとなり、セクション別表示が出ない

```
[セクション分割] 完了: 1セクション
[セクション分割]   1. 回答: 2741文字
```

---

## 原因

AI（Gemini）が `##` 見出しを使わずに回答していたため、セクション分割ができなかった。

```python
# 問題のプロンプト
prompt = f"""あなたはHTML/CSS/プログラミングの実装エキスパートです。
以下の参考情報を元に、質問に対して具体的に回答してください。
...
"""
# → AIは自由形式で回答し、## 見出しを使わない
```

**根本原因**:
- AIに見出し付きで回答させる指示がなかった
- セクション分割は `##` で始まる行を検出するが、AIが `##` を使わなければ分割できない

---

## 対処

プロンプトに見出し付き回答の指示を追加。

```python
# 修正後のプロンプト
prompt = f"""あなたはHTML/CSS/プログラミングの実装エキスパートです。
以下の参考情報を元に、質問に対して具体的に回答してください。
コードが関係する場合は、具体的なコード例を含めてください。
回答は日本語でお願いします。

【重要】回答は必ず ## 見出しで2〜4つのセクションに分けて構造化してください。
例:
## 基本的な使い方
（説明...）
## 実装例
（コード例...）
## 注意点
（補足...）

{context_text}

質問: {question}

回答:"""
```

---

## 修正ファイル

- `modules/llm.py` (行40-58)

---

## 予防策

- AI回答の形式を指定する場合は、プロンプトに明示的に指示する
- セクション分割に依存する機能は、分割ができない場合のフォールバックを用意する

---

## 学んだこと

- AIは指示されない限り見出しを使わない可能性がある
- 機能の前提条件（見出しの存在）をプロンプトで確保する必要がある
